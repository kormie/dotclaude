# Modern Tmux Configuration - Optimized for Claude Code Development
# Requires tmux 3.0+
#
# Key Binding Philosophy (Vim-Optimized):
# - CapsLock rebound to Ctrl makes C-a prefix ergonomic
# - Comma (,) used as secondary leader (matching vim mapleader)
# - hjkl navigation throughout (vim-style)
# - | and - for pane splitting (user preference)
# - Netrw-inspired file/directory operations
# - Seamless vim/tmux navigation integration
#
# Essential Bindings:
#   C-a |       Split pane horizontally
#   C-a -       Split pane vertically  
#   C-a hjkl    Navigate panes (vim-style)
#   C-a ,w      Launch Claude Code workspace
#   C-a ,c      New Claude Code session
#   C-a ,n      New neovim session
#   Escape      Enter copy mode
#   C-hjkl      Smart vim/tmux navigation

# ================================
# General Settings
# ================================

# Enable true color and modern terminal features
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color*:Tc"
set -g focus-events on

# Set prefix to Ctrl-a (ergonomic with CapsLock rebound to Ctrl)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Secondary leader key (comma) for vim-style operations
bind , command-prompt

# Enable mouse support
set -g mouse on

# Start windows and panes at 1 (not 0)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase scrollback buffer
set -g history-limit 50000

# Faster command sequences (no delay for escape)
set -s escape-time 0

# Display messages for longer
set -g display-time 2000
set -g display-panes-time 2000

# ================================
# Key Bindings - Vim-Style Navigation
# ================================

# Reload tmux config (vim-like)
bind r source-file ~/.tmux.conf \; display "Config reloaded!"
bind , source-file ~/.tmux.conf \; display "Config reloaded!"

# Pane splitting (your preferred keys)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Vim-style pane navigation (hjkl)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Smart pane switching with Vim integration (CapsLock=Ctrl makes these ergonomic)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

# Vim-style pane resizing (uppercase hjkl, repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window navigation (vim-style with CapsLock=Ctrl ergonomics)
bind -n C-p previous-window
bind -n C-n next-window

# Vim-style window operations
bind c new-window -c "#{pane_current_path}"  # Create window in current path
bind x kill-pane                            # Close pane (vim-like)
bind X kill-window                          # Close window
bind & kill-window                          # Alternative (default)

# Netrw-inspired file navigation
bind e split-window -h -c "#{pane_current_path}" \; send-keys "ls -la" Enter
bind E split-window -v -c "#{pane_current_path}" \; send-keys "ls -la" Enter

# Session management for Claude Code workflows (vim-style)
bind C-c new-session
bind C-f command-prompt -p "find-session:" "switch-client -t %%"
bind , new-session -c "#{pane_current_path}"    # New session with comma (like vim leader)

# Copy mode (vi-style, enhanced for vim users)
setw -g mode-keys vi
bind Escape copy-mode                           # Enter copy mode (vim-like)
bind p paste-buffer                             # Paste (vim-like)

# Copy mode bindings (vim-style)
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

# Vim-style search in copy mode
bind -T copy-mode-vi / command-prompt -i -p "search down" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "search up" "send -X search-backward-incremental \"%%%\""

# Vim-style text objects in copy mode
bind -T copy-mode-vi w send-keys -X next-word
bind -T copy-mode-vi b send-keys -X previous-word
bind -T copy-mode-vi e send-keys -X next-word-end

# Quick pane synchronization toggle (useful for Claude sessions)
bind S setw synchronize-panes \; display "Pane sync #{?synchronize-panes,ON,OFF}"

# Vim-style zoom toggle
bind z resize-pane -Z \; display "Zoom #{?window_zoomed_flag,ON,OFF}"

# ================================
# Claude Code Specific Bindings (Vim-Style)
# ================================

# Quick workspace setup for Claude Code development (vim-leader style)
bind C-w display-popup -E "tmux-claude-workspace"
bind ,w display-popup -E "tmux-claude-workspace"         # Alternative with comma leader

# Open new window/pane with Claude Code (vim-style)
bind ,c new-window -c "#{pane_current_path}" -n "claude" "claude-code ."
bind ,s split-window -h -c "#{pane_current_path}" "claude-code ."
bind ,v split-window -v -c "#{pane_current_path}" "claude-code ."

# Quick neovim sessions (vim-style)
bind ,n new-window -c "#{pane_current_path}" -n "nvim" "nvim ."
bind ,e split-window -h -c "#{pane_current_path}" "nvim ."

# Git operations (netrw-inspired navigation)
bind g split-window -h -c "#{pane_current_path}" "git status; $SHELL"
bind G new-window -c "#{pane_current_path}" -n "git" "git status; $SHELL"

# Directory navigation (netrw-style)
bind o split-window -h -c "#{pane_current_path}"        # Open horizontal split
bind O split-window -v -c "#{pane_current_path}"        # Open vertical split  
bind t new-window -c "#{pane_current_path}"             # Open new tab/window

# Quick commands (vim-style with comma leader)
bind ,q kill-session                                    # Quit session
bind ,r source-file ~/.tmux.conf \; display "Reloaded!" # Reload config
bind ,l list-sessions                                   # List sessions
bind ,d detach-client                                   # Detach (like :q in vim)

# Buffer management (vim-style)
bind b list-buffers                                     # List buffers (:ls equivalent)
bind B choose-buffer                                    # Choose buffer (:b equivalent)

# ================================
# Status Bar - Claude Code Optimized
# ================================

# Status bar position and refresh
set -g status-position bottom
set -g status-interval 5

# Colors (dracula-inspired for consistency with git delta)
set -g status-style 'bg=#282a36 fg=#f8f8f2'
set -g status-left-style 'bg=#6272a4 fg=#f8f8f2'
set -g status-right-style 'bg=#6272a4 fg=#f8f8f2'

# Window status colors
setw -g window-status-current-style 'bg=#50fa7b fg=#282a36 bold'
setw -g window-status-style 'bg=#44475a fg=#f8f8f2'
setw -g window-status-activity-style 'bg=#ff5555 fg=#f8f8f2'

# Pane border colors
set -g pane-border-style 'fg=#6272a4'
set -g pane-active-border-style 'fg=#50fa7b'

# Status bar content
set -g status-left-length 40
set -g status-right-length 80

# Left: session name and current directory
set -g status-left '#[bg=#6272a4,fg=#f8f8f2,bold] #S #[bg=#282a36] #{b:pane_current_path} '

# Right: git branch, system info, time
set -g status-right '#[fg=#8be9fd]#(cd #{pane_current_path}; git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "no-git")#[fg=#f8f8f2] | #[fg=#ffb86c]%H:%M#[fg=#f8f8f2] | #[fg=#ff79c6]%d-%b'

# Window status format
setw -g window-status-current-format ' #I:#W#{?window_zoomed_flag,*Z,} '
setw -g window-status-format ' #I:#W '

# ================================
# Plugin Configuration
# ================================

# Plugin manager (TPM) - install with: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
set -g @plugin 'tmux-plugins/tpm'

# Essential plugins for Claude Code development
set -g @plugin 'tmux-plugins/tmux-sensible'          # Sensible defaults
set -g @plugin 'tmux-plugins/tmux-resurrect'         # Session persistence
set -g @plugin 'tmux-plugins/tmux-continuum'         # Automatic session saving
set -g @plugin 'tmux-plugins/tmux-yank'             # Better copy/paste
set -g @plugin 'tmux-plugins/tmux-open'             # Open files/URLs from tmux
set -g @plugin 'tmux-plugins/tmux-logging'          # Log tmux output (useful for Claude sessions)

# Plugin configurations
set -g @resurrect-strategy-nvim 'session'           # Restore neovim sessions
set -g @resurrect-capture-pane-contents 'on'        # Restore pane contents
set -g @continuum-restore 'on'                      # Auto-restore on tmux start
set -g @continuum-save-interval '15'                # Save every 15 minutes

# Logging plugin config (useful for reviewing Claude Code sessions)
set -g @logging-path "$HOME/.tmux/logs"
set -g @screen-capture-key 'M-c'
set -g @save-complete-history-key 'M-C'

# ================================
# Claude Code Specific Settings
# ================================

# Set environment variables for Claude Code sessions
set-environment -g CLAUDE_CODE_TMUX_SESSION 1
set-environment -g EDITOR nvim

# Better handling of long outputs (common in Claude Code sessions)
setw -g aggressive-resize on
set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# Enable focus events for file watchers
set -g focus-events on

# ================================
# Initialize Plugin Manager
# ================================

# Initialize TMUX plugin manager (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'