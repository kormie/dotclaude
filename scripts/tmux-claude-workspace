#!/bin/bash

# tmux-claude-workspace - Set up optimized tmux workspace for Claude Code development
# Usage: tmux-claude-workspace [project-name] [feature1] [feature2] [feature3] [feature4] [feature5]
#
# project-name: Used for tmux session naming (claude-dev-${project-name})
#               Defaults to current directory name if not provided
#               Allows multiple workspaces and easy session identification

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_workspace() {
    echo -e "${PURPLE}[WORKSPACE]${NC} $1"
}

# Default configuration
PROJECT_NAME="${1:-$(basename "$(pwd)")}"
FEATURES=()
SESSION_NAME="claude-dev-${PROJECT_NAME}"

# Parse feature arguments (2-6 features supported)
for i in {2..6}; do
    if [[ -n "${!i}" ]]; then
        FEATURES+=("${!i}")
    fi
done

# Default to single feature if none provided
if [[ ${#FEATURES[@]} -eq 0 ]]; then
    FEATURES=("feature-1")
fi

# Validate feature count (1-5 features)
if [[ ${#FEATURES[@]} -gt 5 ]]; then
    log_error "Maximum 5 features supported. Provided: ${#FEATURES[@]}"
    exit 1
fi

# Check if we're in a git repository
check_git_repo() {
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        log_error "Not in a git repository. Please run from within a git repo."
        exit 1
    fi
}

# Check if tmux is available
check_tmux() {
    if ! command -v tmux &> /dev/null; then
        log_error "tmux is not installed. Please install tmux first."
        exit 1
    fi
}

# Check if claude is available
check_claude() {
    if ! command -v claude &> /dev/null; then
        log_warn "claude command not found. Will use placeholders in tmux panes."
        return 1
    fi
    return 0
}

# Create git worktrees for parallel development
setup_worktrees() {
    local base_dir="$(pwd)"
    local worktree_dir="${base_dir}/.worktrees"
    
    log_info "Setting up git worktrees in ${worktree_dir}"
    
    # Create worktree directory if it doesn't exist
    mkdir -p "$worktree_dir"
    
    # Create worktrees for each feature
    for feature in "${FEATURES[@]}"; do
        local worktree_path="${worktree_dir}/${feature}"
        
        if [[ -d "$worktree_path" ]]; then
            log_warn "Worktree already exists: $worktree_path"
        else
            # Create branch if it doesn't exist
            if ! git rev-parse --verify "$feature" >/dev/null 2>&1; then
                log_info "Creating branch: $feature"
                git branch "$feature" >/dev/null 2>&1
            fi
            
            # Create worktree
            log_info "Creating worktree: $worktree_path"
            git worktree add "$worktree_path" "$feature" >/dev/null 2>&1
        fi
    done
    
    echo "$worktree_dir"
}

# Kill existing session if it exists
cleanup_existing_session() {
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        log_warn "Killing existing session: $SESSION_NAME"
        tmux kill-session -t "$SESSION_NAME"
    fi
}

# Create the optimized tmux layout
create_tmux_layout() {
    local base_dir="$(pwd)"
    local worktree_dir="$1"
    local claude_available="$2"
    local num_features=${#FEATURES[@]}
    
    log_workspace "Creating tmux session: $SESSION_NAME with $num_features features"
    
    # Create new session (detached)
    tmux new-session -d -s "$SESSION_NAME" -c "$base_dir" >/dev/null 2>&1
    
    # Rename first window
    tmux rename-window -t "$SESSION_NAME:1" "claude-workspace" >/dev/null 2>&1
    
    # Create horizontal layout: features across top, single terminal at bottom
    setup_horizontal_layout "$worktree_dir" "$claude_available" "$num_features"
    
    # Start in the first Claude Code pane
    tmux select-pane -t "$SESSION_NAME:1.1" >/dev/null 2>&1
}

# Set up horizontal layout with features across top and terminal at bottom
setup_horizontal_layout() {
    local worktree_dir="$1"
    local claude_available="$2"
    local num_features="$3"
    
    # Create horizontal splits for each feature (top row)
    for ((i=1; i<num_features; i++)); do
        tmux split-window -h -t "$SESSION_NAME:1" -c "${worktree_dir}/${FEATURES[$i]}" >/dev/null 2>&1
    done
    
    # Create bottom terminal pane (spans full width)
    tmux split-window -v -t "$SESSION_NAME:1.1" -c "$(pwd)" >/dev/null 2>&1
    
    # Resize to give Claude panes 75% of height
    tmux resize-pane -t "$SESSION_NAME:1.$((num_features + 1))" -y 25% >/dev/null 2>&1
    
    # Set up each pane
    for ((i=0; i<num_features; i++)); do
        setup_claude_pane "$((i+1))" "${FEATURES[$i]}" "$worktree_dir" "$claude_available"
    done
    
    # Set up bottom terminal pane with worktree switching
    setup_terminal_pane "$((num_features + 1))" "$worktree_dir"
}

# Set up individual panes
setup_claude_pane() {
    local pane_num="$1"
    local feature="$2"
    local worktree_dir="$3"
    local claude_available="$4"
    local pane="$SESSION_NAME:1.$pane_num"
    
    log_workspace "Setting up Claude Code session $pane_num: $feature"
    
    # Set pane title
    tmux select-pane -t "$pane" -T "Claude: $feature" >/dev/null 2>&1
    
    if [[ "$claude_available" == "true" ]]; then
        tmux send-keys -t "$pane" "cd ${worktree_dir}/${feature}" Enter
        tmux send-keys -t "$pane" "echo 'Starting Claude Code Session: $feature'" Enter
        tmux send-keys -t "$pane" "claude ." Enter
    else
        tmux send-keys -t "$pane" "cd ${worktree_dir}/${feature}" Enter
        tmux send-keys -t "$pane" "echo 'Worktree: $feature (claude not available)'" Enter
    fi
}

setup_terminal_pane() {
    local pane_num="$1"
    local worktree_dir="$2"
    local pane="$SESSION_NAME:1.$pane_num"
    
    log_workspace "Setting up terminal with worktree switching"
    
    # Set pane title
    tmux select-pane -t "$pane" -T "Terminal (Worktree Switcher)" >/dev/null 2>&1
    
    # Create worktree switching function
    local switch_function="cw-switch() {
        if [[ \$# -eq 0 ]]; then
            echo 'Available worktrees:'
            for i in \${!FEATURES[@]}; do
                echo \"  \$((i+1)). \${FEATURES[\$i]}\"
            done
            echo 'Usage: cw-switch <number>'
            return
        fi
        
        local choice=\$1
        if [[ \$choice -ge 1 && \$choice -le \${#FEATURES[@]} ]]; then
            local feature=\${FEATURES[\$((choice-1))]}
            cd \"${worktree_dir}/\${feature}\"
            echo \"Switched to worktree: \${feature}\"
            git status
        else
            echo \"Invalid choice. Use 1-\${#FEATURES[@]}\"
        fi
    }"
    
    # Set up the terminal pane
    tmux send-keys -t "$pane" "cd $(pwd)" Enter
    tmux send-keys -t "$pane" "FEATURES=(${FEATURES[*]})" Enter
    tmux send-keys -t "$pane" "$switch_function" Enter
    tmux send-keys -t "$pane" "echo 'Terminal ready - use cw-switch <1-${#FEATURES[@]}> to switch worktrees'" Enter
    tmux send-keys -t "$pane" "cw-switch" Enter
}

# Display usage information
show_workspace_info() {
    local worktree_dir="$1"
    local num_features=${#FEATURES[@]}
    
    log_info "Claude Code Development Workspace Ready!"
    echo
    echo -e "${BLUE}Session:${NC} $SESSION_NAME (project: $PROJECT_NAME)"
    echo -e "${BLUE}Features:${NC} ${FEATURES[*]}"
    echo -e "${BLUE}Worktrees:${NC} $worktree_dir"
    echo
    echo -e "${PURPLE}Pane Layout:${NC}"
    
    # Dynamic layout display based on number of features
    local top_line="  ┌"
    local feature_line="  │"
    local bottom_line="  └"
    
    for ((i=0; i<num_features; i++)); do
        if [[ $i -eq 0 ]]; then
            top_line+="─────────────────"
            feature_line+=" Claude: ${FEATURES[$i]}"
            bottom_line+="─────────────────"
        else
            top_line+="┬─────────────────"
            feature_line+=" │ Claude: ${FEATURES[$i]}"
            bottom_line+="┴─────────────────"
        fi
    done
    
    top_line+="┐"
    feature_line+=" │"
    bottom_line+="┐"
    
    echo "$top_line"
    echo "$feature_line"
    echo "  ├$(printf '─%.0s' $(seq 1 $((17 * num_features + num_features - 1))))┤"
    echo "  │$(printf ' %.0s' $(seq 1 $((17 * num_features + num_features - 1))))│"
    echo "  │          Terminal (Worktree Switcher)$(printf ' %.0s' $(seq 1 $((17 * num_features + num_features - 1 - 35))))│"
    echo "  │$(printf ' %.0s' $(seq 1 $((17 * num_features + num_features - 1))))│"
    echo "  └$(printf '─%.0s' $(seq 1 $((17 * num_features + num_features - 1))))┘"
    echo
    echo -e "${GREEN}Commands:${NC}"
    echo "  Attach: tmux attach-session -t $SESSION_NAME"
    echo "  Detach: Ctrl-a + d"
    echo "  Switch panes: Ctrl-a + hjkl (vim-style)"
    echo "  Sync panes: Ctrl-a + S (toggle)"
    echo "  Worktree switch: cw-switch <1-$num_features> (in terminal pane)"
    echo
    echo -e "${YELLOW}Quick Start:${NC}"
    echo "  1. Attach to session"
    echo "  2. Top panes: claude . (parallel Claude Code sessions)"
    echo "  3. Bottom pane: Use cw-switch to navigate between worktrees"
    echo "  4. Use Ctrl-a + hjkl to navigate between panes"
}

# Clean up worktrees (optional)
cleanup_worktrees() {
    local worktree_dir="$1"
    
    read -p "Remove worktrees when done? (y/N): " cleanup_choice
    if [[ "$cleanup_choice" =~ ^[Yy]$ ]]; then
        log_info "Cleaning up worktrees..."
        for feature in "${FEATURES[@]}"; do
            git worktree remove "${worktree_dir}/${feature}" 2>/dev/null || true
        done
        rmdir "$worktree_dir" 2>/dev/null || true
        log_info "Worktrees cleaned up"
    fi
}

# Main function
main() {
    log_info "Setting up Claude Code development workspace"
    log_info "Project: $PROJECT_NAME | Features: ${FEATURES[*]}"
    
    # Validation
    check_git_repo
    check_tmux
    local claude_available="false"
    if check_claude; then
        claude_available="true"
    fi
    
    # Setup
    cleanup_existing_session
    local worktree_dir
    worktree_dir=$(setup_worktrees)
    create_tmux_layout "$worktree_dir" "$claude_available"
    
    # Information
    show_workspace_info "$worktree_dir"
    
    # Attach to session
    log_info "Attaching to tmux session..."
    tmux attach-session -t "$SESSION_NAME"
    
    # Optional cleanup after session ends
    cleanup_worktrees "$worktree_dir"
}

# Handle script arguments
case "${1:-}" in
    -h|--help)
        echo "Usage: tmux-claude-workspace [project-name] [feature1] [feature2] [feature3] [feature4] [feature5]"
        echo
        echo "Creates an optimized tmux workspace for Claude Code development with:"
        echo "  - 1-5 horizontal Claude Code sessions in separate git worktrees"
        echo "  - 1 bottom terminal pane with worktree switching capability"
        echo
        echo "Arguments:"
        echo "  project-name    Name for tmux session (claude-dev-PROJECT_NAME)"
        echo "                  Used for session identification and multi-project support"
        echo "                  Defaults to current directory name if not provided"
        echo "  feature1-5      Names for feature branches/worktrees"
        echo "                  Creates git branches and worktrees automatically"
        echo "                  Defaults to 'feature-1' if no features provided"
        echo
        echo "Terminal Commands (available in bottom pane):"
        echo "  cw-switch       List available worktrees"
        echo "  cw-switch <N>   Switch to worktree N (1-based index)"
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac